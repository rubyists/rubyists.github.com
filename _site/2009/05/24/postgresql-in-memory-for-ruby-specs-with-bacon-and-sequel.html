<p><strong>The Problem</strong> In the past with BDD and writing specifications for ruby applications which used postgresql, I&#8217;d resorted to environment variables specifying some environment, which I&#8217;d then place a conditional somewhere so if the environment was &#8220;test&#8221; it would use that already-existing database server and database. The permissions problems with this were numerous, so we eventually moved to keeping an instance of postgres up that was just a test server for these test databases. Maintenance was not easy.</p>

<p>Other tactics we&#8217;ve used, especially when starting a project or on one which does not use postgres-specific code, we&#8217;d use Sqlite3 databases in-memory for our specifications. This led, at times, to inconsistencies with how postgres would handle data or functions, and again became a maintenance nightmare as soon as we wanted to put the power of postgres to work and Sqlite3 could not support the specs anymore.</p>

<p>On a small project using Ramaze, Sequel, and Bacon for specs, manveru and I came across a solution which, while not as simple as Sqlite in memory, accomplishes the same encapsulation with none of the security risks of the postgres test server or test-database on a multi-purpose server scenario.</p>

<p><strong>The Solution</strong> Create a database in a ram filesystem (/dev/shm mounted as tmpfs on linux), initialize a postgres cluster there, start the db server, and the user who does so has God rights to create/drop/manipulate the db without chance of affecting anyone else. The db_helper.rb we use to accomplish this follows</p>
<pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;typo:code lang=&quot;ruby&quot;&gt;
begin
  require &quot;sequel&quot;
rescue LoadError
  require &quot;rubygems&quot;
  require &quot;sequel&quot;
end
require &quot;logger&quot;
ENV[&quot;PGHOST&quot;] = PGHOST = &quot;/tmp&quot;
ENV[&quot;PGPORT&quot;] = PGPORT = &quot;5433&quot;
SHM = &quot;/dev/shm&quot;
ENV[&apos;PGDATA&apos;] = PGDATA = &quot;#{SHM}/fxc&quot;
DB_LOG = Logger.new(&quot;/tmp/fxc_spec.log&quot;)

def runcmd(command)
  IO.popen(command) do |sout|
    out = sout.read.strip
    out.each_line { |l| DB_LOG.info(l) }
  end
  $? == 0 ? true : false
end

def startdb
  return true if runcmd %{pg_ctl status -o &quot;-k /tmp&quot;}
  DB_LOG.info &quot;Starting DB&quot;
  runcmd %{pg_ctl start -w -o &quot;-k /tmp&quot; -l /tmp/fxcdb.log}
end

def stopdb
  DB_LOG.info &quot;Stopping DB&quot;
  if runcmd %{pg_ctl status -o &quot;-k /tmp&quot;}
    runcmd %{pg_ctl stop -w -o &quot;-k /tmp&quot;}
  else
    true
  end
end

def initdb
  raise &quot;#{SHM} not found!&quot; unless File.directory?(SHM)
  return true if File.directory?(PGDATA)
  runcmd %{initdb}
end

def createdb
  runcmd %{dropdb fxc}
  runcmd %{createdb fxc}
end

raise &quot;initdb failed&quot; unless initdb
raise &quot;startdb failed&quot; unless startdb
raise &quot;createdb failed&quot; unless createdb

DB = Sequel.postgres(&quot;fxc&quot;, :user =&gt; ENV[&quot;USER&quot;], :host =&gt; PGHOST, :port =&gt; PGPORT)
require &apos;sequel/extensions/migration&apos;
require File.expand_path(&apos;../../lib/fxc&apos;, __FILE__)

# go to latest migration
Sequel::Migrator.apply(DB, FXC::MIGRATION_ROOT)

require FXC::SPEC_HELPER_PATH/:helper
&lt;/typo:code&gt;</pre>
<p><strong>The Result</strong> Running our specs is now much faster, especially after the first run which initializes the cluster.</p>
<pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;typo:code lang=&quot;plaintext&quot;&gt;
## Before we run, stop the test db and wipe it out of memory
bougyman@zero:~$ pg_ctl -o &quot;-k /tmp/&quot; stop
waiting for server to shut down.... done
server stopped
bougyman@zero:~$ rm -rf /dev/shm/fxc/
## Run the specs (it&apos;s initting a whole new db in ram on this run)
bougyman@zero:~$ time rake
(in /home/bougyman/git_checkouts/fxc)
   1/4: spec/model/target.rb                  1 passed
   2/4: spec/model/user.rb                    1 passed
   3/4: spec/view/dialplan.rb                 1 passed
   4/4: spec/view/directory.rb                3 passed
6 specifications (29 requirements), 0 failures, 0 errors

real    0m8.176s
user    0m0.200s
sys     0m0.056s
## Run the specs again (db is initialized already here, just run specs)
bougyman@zero:~$ time rake
(in /home/bougyman/git_checkouts/fxc)
   1/4: spec/model/target.rb                  1 passed
   2/4: spec/model/user.rb                    1 passed
   3/4: spec/view/dialplan.rb                 1 passed
   4/4: spec/view/directory.rb                3 passed
6 specifications (29 requirements), 0 failures, 0 errors

real    0m2.417s
user    0m0.216s
sys     0m0.044s
## Much faster on runs after the db is initialized
&lt;/typo:code&gt;</pre>