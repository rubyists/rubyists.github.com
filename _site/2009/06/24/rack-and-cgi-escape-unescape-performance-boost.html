<p>As performance boosts are about speed, we&#8217;ll start with the benchmarks. Here is a run of spec/bench.rb, from the url_escape source tree.</p>
<strong>Escape</strong><hr /><table>
<tr>
  <th>-</th>
  <th>user</th>
  <th>system</th>
  <th>total</th>
  <th>real</th>
</tr>
<tr>
  <td>URLEscape::escape</td>
  <td>0.200000</td>
  <td>0.000000</td>
  <td>0.200000</td>
  <td>(  0.196100)</td>
</tr>
<tr>
  <td>CGI::escape</td>         
  <td>3.830000 </td>
  <td>0.010000</td>
  <td>3.840000</td>
  <td>(  3.828438)</td>
</tr>
<tr>
  <td>Rack::Utils::escape</td>
   <td>3.880000</td>
   <td>0.010000</td>   
   <td>3.890000</td>
   <td>(  3.880745)</td>
</tr>
</table><br /><strong>Unescape</strong><hr /><table>
  <tr>
    <th>-</th>
    <th>user</th>
    <th>system</th>
    <th>total</th>
    <th>real</th>
  </tr>
  <tr>
    <td>URLEscape::unescape</td>
   <td>0.090000</td>   
   <td>0.000000</td>
   <td>0.090000</td> 
   <td>(  0.089190)</td>
  </tr>
  <tr>
    <td>CGI::unescape</td>
    <td>2.820000</td>   
    <td>0.000000</td>  
    <td>2.820000</td> 
     <td>(  2.816234)</td>
  </tr>
  <tr>
    <td>Rack::Utils::unescape</td>
    <td>3.140000</td>
    <td>0.000000</td>  
    <td> 3.140000</td> 
    <td>(  3.137291)</td>
  </tr>
</table><br /><strong>URLEscape</strong>
<p>use on ruby 1.8.6-8 and 1.9.1+; tested on linux, XP, and Vista. <br /> The jruby version uses the java stdlib&#8217;s java.net.URLEncoder and URLDecoder. We only see a 200-700% increase with this change, and would like to improve on those numbers.</p>

<h3 id='why'>Why?</h3>

<p>Josh Susser initially noticed the ability to overload #escape and #unescape while testing a client application. At the same time, we had just come across a bottleneck when regression testing FXC (a web app which serves configuration information to the FreeSWITCH softswitch) where requests were being delayed in our rack middleware, which parses the POST data sent by FreeSWITCH and routes requests to the ramaze application for processing. The delay was noticeable under loads of only 50 req/second; where rack became the bottleneck, not ramaze, the db, or any other factor. Adding the above library (on linux, with ruby 1.9.1) removed the delay in rack, pushing the work back to to the web app (or database) where it&#8217;s free to be as slow as it must. Optimally we&#8217;d like to perform at a speed equal to the database, making it the final bottleneck in a dynamic application.</p>

<h3 id='installation_and_usage'>Installation and Usage</h3>

<h4 id='to_use_urlescape_standalone'>To use URLEscape standalone</h4>

<p>Install with one of the following methods:</p>

<ul>
<li>gem install url_escape</li>

<li>get the tarball from <a href='http://url-escape.rubyforge.org'>RubyForge</a></li>

<li>get the source from <a href='http://github.com/bougyman/url_escape'>GitHub</a> and rake install in the source top-level.</li>
</ul>

<p>Then simply require &#8220;url_escape&#8221; and you have access to URLEscape.escape(string) and URLEscape.unescape(string)</p>

<h4 id='to_use_urlescapes_escapeunescape_in_place_of_cgi_or_rackutils_versions'>To use URLEscape&#8217;s escape/unescape in place of CGI or Rack::Utils versions</h4>

<blockquote>
<p>gem install rack_fast_escape</p>
</blockquote>

<p>or</p>

<blockquote>
<p>gem install cgi_fast_escape</p>
</blockquote>

<p>This will install url_escape if it&#8217;s not already installed, as well.</p>

<p>You can optionally install <a href='http://github.com/bougyman/rack_fast_escape'>rack_fast_escape</a> or <a href='http://github.com/bougyman/cgi_fast_escape'>cgi_fast_escape</a> from rubyforge&#8217;s tarball or the github source (rake install as with url_escape). If you use tarball or source rake install, <em>you will have to manually install url_escape first.</em></p>

<p>Once installed, simply use</p>
<pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;typo:code lang=&quot;ruby&quot;&gt;
require &quot;rack_fast_escape&quot;
&lt;/typo:code&gt;</pre>
<p>to replace Rack::Utils version, or</p>
<pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
&lt;typo:code lang=&quot;ruby&quot;&gt;
require &quot;cgi_fast_escape&quot;
&lt;/typo:code&gt;</pre>
<p>to replace the CGI version.</p>

<h3 id='what_else'>What else?</h3>

<p>The ability of large posts to slow down a web application cannot be removed by just speeding up the POST parser. In order to alleviate the risk of such large POSTs being used to deny a service, firewall or web server throttling or limiting is a more reliable protection to enable. Here are a few examples:</p>

<ul>
<li>
<p>Lighttpd: http://lighttpd.net * Offers mod_evasive which limits connections per ip, as well as the ability to limit the data rate per connection.</p>
</li>

<li>
<p>Nginx: http://nginx.org * Flexible limiting system, per vhost, per user, per connection.</p>
</li>

<li>
<p>Netfilter/QoS (linux): http://l7-filter.sourceforge.net/ * Allow classifiation of HTTP packets so iptables/tc or whatever utility you&#8217;d like can have the info it needs about the HTTP protocol to make limiting/dropping/queueing decisions</p>
</li>

<li>
<p>Others: Apache, Squid, Litespeed, many others will have various methods of limiting size and frequency of requests.</p>
</li>
</ul>

<h3 id='side_note'>Side Note</h3>

<p>When speccing these libraries, a few implementation differences came to light which we&#8217;ll highlight here.</p>

<ol>
<li>Rack::Utils and CGI both throw errors on a mixed ASCII and Unicode string in ruby 1.9.1 and above</li>

<li>Java&#8217;s URLDecoder and URLEncoder do not escape or unescape mixed ASCII/Unicode properly.</li>
</ol>

<p>URLEscape (the C version) handles these cases properly, though we don&#8217;t expect you&#8217;d see them much in proper requests.</p>

<h3 id='thanks'>Thanks</h3>

<p>To Evan Phoenix, Josh Susser, Trey Dempsey, Jayson Vaughn, Michael Fellinger, Kevin Berry, and all the other contributors of ideas and support who made this product a reality.</p>

<h3 id='license'>License</h3>

<p>Nothing to fear, it&#8217;s MIT</p>